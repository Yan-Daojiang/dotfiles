#!/bin/bash
set -euo pipefail

REMOTE_NAME="origin"

# å‚æ•°æ ¡éªŒ
if [ $# -ne 1 ]; then
    echo "ğŸš— ç”¨æ³•: $0 <repo_path>"
    echo "ç¤ºä¾‹: $0 /home/user/myrepo"
    exit 1
fi

REPO_PATH="$1"

# æ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
if [ ! -d "$REPO_PATH/.git" ]; then
    echo "âŒ $REPO_PATH ä¸æ˜¯ä¸€ä¸ª Git ä»“åº“"
    exit 1
fi

cd "$REPO_PATH"

# æ£€æŸ¥å·¥ä½œåŒºæ˜¯å¦å¹²å‡€
temp_commit=false
if ! git diff-index --quiet HEAD --; then
    echo "âš ï¸ å·¥ä½œåŒºä¸å¹²å‡€ï¼Œä¸´æ—¶æäº¤ä¿å­˜ä¿®æ”¹ï¼Œèµ¶ç´§æ¨é€ğŸš¦"
    git add -A
    git commit -m "chore: temp commit before push"
    temp_commit=true
fi

# è·å–æ‰€æœ‰æœ¬åœ°åˆ†æ”¯
branches=$(git for-each-ref --format='%(refname:short)' refs/heads/)
if [ -z "$branches" ]; then
    echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æœ¬åœ°åˆ†æ”¯"
    exit 1
fi

# æ›´æ–°è¿œç¨‹ä¿¡æ¯
git fetch "$REMOTE_NAME"

echo "ğŸ“Œ å¼€å§‹æ¨é€åˆ†æ”¯ï¼ŒæŠ“ç´§æ—¶é—´â±ï¸"

for branch in $branches; do
    echo "ğŸš€ å½“å‰åˆ†æ”¯: $branch"

    if [[ "$branch" == "master" || "$branch" == "main" ]]; then
        # master/main åˆ†æ”¯è‡ªåŠ¨ rebase
        echo "ğŸ”„ å¤„ç† $branch åˆ†æ”¯ï¼šrebase å¹¶æ¨é€"
        git checkout "$branch"
        git pull --rebase "$REMOTE_NAME" "$branch"
        git push "$REMOTE_NAME" "$branch"
    else
        # éä¸»åˆ†æ”¯ï¼Œç›´æ¥æ¨é€
        echo "ğŸš€ æ¨é€éä¸»åˆ†æ”¯: $branch"
        git checkout "$branch"
        git push "$REMOTE_NAME" "$branch"
    fi
done

# å›æ»šä¸´æ—¶æäº¤
if [ "$temp_commit" = true ]; then
    echo "ğŸ”„ æ¨é€å®Œæˆï¼Œå›æ»šä¸´æ—¶æäº¤ï¼Œå·¥ä½œåŒºæ¢å¤åŸçŠ¶ğŸ"
    git reset HEAD~1
fi

echo "âœ… æ‰€æœ‰åˆ†æ”¯å·²æ¨é€å®Œæˆï¼Œèµ¶ç´§ä¸‹ç­å§ï¼ğŸš—ğŸ’¨"
